<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0D47A1">
  <title>ChatDCuba</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0D47A1; --primary-dark: #083278; --primary-light: #BBDEFB;
      --secondary: #FF6B35; --accent: #00ACC1;
      --bg: #F8FAFC; --bg-card: #FFFFFF; --bg-input: #F1F5F9;
      --text: #1E293B; --text-sec: #64748B; --text-muted: #94A3B8;
      --border: #E2E8F0; --success: #22C55E; --warning: #F59E0B; --error: #EF4444;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --radius: 12px; --radius-full: 9999px;
      --header-h: 56px; --touch: 44px;
    }
    [data-dark] {
      --bg: #0F172A; --bg-card: #1E293B; --bg-input: #334155;
      --text: #F1F5F9; --text-sec: #94A3B8; --text-muted: #64748B; --border: #334155;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { font-size: 16px; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    
    .hidden { display: none !important; }
    .flex { display: flex; } .flex-col { flex-direction: column; }
    .items-center { align-items: center; } .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; } .gap-3 { gap: 12px; }
    .p-3 { padding: 12px; } .p-4 { padding: 16px; }
    .rounded { border-radius: var(--radius); } .rounded-full { border-radius: var(--radius-full); }
    .font-semibold { font-weight: 600; } .text-sm { font-size: 14px; } .text-xs { font-size: 12px; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .touch { min-height: var(--touch); min-width: var(--touch); }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-slide { animation: slideUp 0.3s ease; }
    .animate-bounce { animation: bounce 1.4s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-fade { animation: fadeIn 0.2s ease; }
    
    #login { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 500; }
    .login-card { background: var(--bg-card); border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideUp 0.4s ease; }
    .login-logo { text-align: center; margin-bottom: 24px; }
    .login-logo-icon { width: 72px; height: 72px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; color: white; }
    .login-logo h1 { font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .login-logo p { color: var(--text-sec); font-size: 14px; }
    .input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-input); color: var(--text); font-size: 16px; margin-bottom: 16px; font-family: inherit; }
    .input:focus { outline: none; border-color: var(--primary); background: var(--bg-card); }
    .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
    .btn-secondary { background: var(--bg-input); color: var(--text); }
    
    #app { display: none; height: 100vh; flex-direction: column; }
    .header { background: var(--bg-card); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; height: var(--header-h); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .header-title { font-size: 18px; font-weight: 700; color: var(--primary); }
    .icon-btn { width: var(--touch); height: var(--touch); border-radius: var(--radius); border: none; background: transparent; color: var(--text-sec); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
    .icon-btn:hover { background: var(--bg-input); color: var(--primary); }
    
    .main-content { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 16px; }
    .stories-bar { background: var(--bg-card); border-radius: 16px; padding: 12px 16px; border: 1px solid var(--border); }
    .stories-bar-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
    .stories-list { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 4px; }
    .story-item { flex-shrink: 0; width: 68px; text-align: center; cursor: pointer; }
    .story-ring { width: 60px; height: 60px; border-radius: var(--radius-full); padding: 3px; margin: 0 auto 6px; background: linear-gradient(135deg, var(--secondary), var(--accent)); }
    .story-ring.has-story { border: 3px solid var(--warning); }
    .story-avatar { width: 100%; height: 100%; border-radius: var(--radius-full); background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; color: var(--primary); overflow: hidden; }
    .story-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .story-add { position: relative; background: var(--bg-input); }
    .story-add::after { content: '+'; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: var(--success); color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border: 2px solid var(--bg-card); }
    .story-name { font-size: 11px; color: var(--text-sec); }
    .story-name.unseen { font-weight: 600; color: var(--text); }
    
    .chats-section { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
    .chats-header { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .chats-title { font-size: 14px; font-weight: 600; }
    .chats-search { padding: 8px 16px; border-bottom: 1px solid var(--border); }
    .chats-search input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg-input); font-size: 14px; }
    .chat-list { max-height: 300px; overflow-y: auto; }
    .chat-item { padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
    .chat-item:last-child { border-bottom: none; }
    .chat-item:hover { background: var(--bg-input); }
    .chat-avatar { width: 48px; height: 48px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--primary-light), var(--accent)); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; flex-shrink: 0; position: relative; }
    .chat-avatar img { width: 100%; height: 100%; border-radius: var(--radius-full); object-fit: cover; }
    .chat-avatar.online::after, .chat-avatar.offline::after { content: ''; position: absolute; bottom: 3px; right: 3px; width: 12px; height: 12px; border-radius: var(--radius-full); border: 2px solid var(--bg-card); }
    .chat-avatar.online::after { background: var(--success); }
    .chat-avatar.offline::after { background: var(--text-muted); }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
    .chat-preview { font-size: 13px; color: var(--text-sec); }
    
    .chat-view { display: none; flex-direction: column; height: 100%; }
    .chat-view.active { display: flex; }
    .chat-view-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .chat-view-back { width: var(--touch); height: var(--touch); border-radius: var(--radius); border: none; background: var(--bg-input); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
    .chat-view-avatar { width: 40px; height: 40px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--primary-light), var(--accent)); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 16px; flex-shrink: 0; }
    .chat-view-details { flex: 1; }
    .chat-view-details h2 { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
    .chat-view-details span { font-size: 12px; color: var(--success); }
    .chat-view-details span.offline { color: var(--text-muted); }
    
    .messages-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .message { max-width: 75%; animation: slideUp 0.25s ease; }
    .message.own { align-self: flex-end; }
    .message.other { align-self: flex-start; }
    .message-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; box-shadow: var(--shadow); }
    .message.own .message-bubble { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-bottom-right-radius: 8px; }
    .message.other .message-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 8px; }
    .message-text { white-space: pre-wrap; }
    .message-image { max-width: 100%; border-radius: 8px; margin: 4px 0; cursor: pointer; }
    .message-meta { font-size: 11px; opacity: 0.8; margin-top: 4px; text-align: right; }
    .system-message { align-self: center; background: var(--bg-card); padding: 6px 12px; border-radius: 20px; font-size: 12px; color: var(--text-sec); text-align: center; border: 1px solid var(--border); }
    
    .typing-indicator { padding: 8px 16px; font-size: 12px; color: var(--text-sec); display: none; background: var(--bg-card); border-top: 1px solid var(--border); }
    .typing-indicator.show { display: flex; align-items: center; gap: 6px; }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dots span { width: 6px; height: 6px; background: var(--text-muted); border-radius: var(--radius-full); animation: bounce 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    .chat-input-area { padding: 12px 16px; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .chat-input-wrapper { flex: 1; display: flex; align-items: center; background: var(--bg-input); border: 2px solid var(--border); border-radius: 20px; padding: 8px 12px; }
    .chat-input-wrapper:focus-within { border-color: var(--primary); }
    .chat-input-wrapper input { flex: 1; background: none; border: none; color: var(--text); font-size: 14px; font-family: inherit; }
    .chat-input-wrapper input:focus { outline: none; }
    .send-btn { width: 44px; height: 44px; border-radius: var(--radius-full); border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); padding: 40px; text-align: center; }
    .empty-icon { width: 64px; height: 64px; border-radius: var(--radius-full); background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 16px; }
    
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text); color: white; padding: 12px 20px; border-radius: var(--radius); font-size: 14px; z-index: 400; transition: transform 0.25s; display: flex; align-items: center; gap: 8px; }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    .toast.warning { background: var(--warning); color: var(--text); }
    
    .connection { position: fixed; top: 0; left: 0; right: 0; background: var(--warning); color: white; padding: 6px 16px; font-size: 12px; text-align: center; z-index: 200; display: none; }
    .connection.show { display: flex; }
    .connection.offline { background: var(--error); }
    
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; animation: fadeIn 0.2s; }
    .modal-content { background: var(--bg-card); border-radius: 24px; width: 100%; max-width: 400px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.3s; }
    .modal-header { padding: 16px 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-close { width: 32px; height: 32px; border-radius: var(--radius-full); border: none; background: rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-body { padding: 20px; overflow-y: auto; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
    
    .story-view { text-align: center; }
    .story-view-ring { width: 72px; height: 72px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--secondary), var(--accent)); padding: 4px; margin: 0 auto 16px; }
    .story-view-avatar { width: 100%; height: 100%; border-radius: var(--radius-full); background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 24px; color: var(--primary); overflow: hidden; }
    .story-view-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .story-view-time { font-size: 12px; color: var(--text-sec); margin-bottom: 20px; }
    .story-view-image { width: 100%; border-radius: 12px; margin-bottom: 16px; cursor: pointer; }
    .story-view-text { background: var(--bg-input); padding: 16px; border-radius: 12px; font-size: 14px; text-align: left; margin-bottom: 20px; white-space: pre-wrap; }
    
    .story-form textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg-input); font-size: 14px; font-family: inherit; resize: vertical; min-height: 100px; margin-bottom: 12px; }
    .story-form textarea:focus { outline: none; border-color: var(--primary); }
    .char-count { text-align: right; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .image-preview { margin-bottom: 12px; text-align: center; }
    .image-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; }
    .file-upload { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg-input); border-radius: 20px; cursor: pointer; font-size: 14px; margin-bottom: 16px; }
    .file-upload input { display: none; }
    
    .settings-section { margin-bottom: 20px; }
    .settings-section h4 { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .setting-item:last-child { border-bottom: none; }
    .setting-info h5 { font-size: 14px; font-weight: 500; }
    .setting-info p { font-size: 12px; color: var(--text-sec); }
    .toggle { position: relative; width: 48px; height: 28px; background: var(--border); border-radius: var(--radius-full); cursor: pointer; }
    .toggle.active { background: var(--primary); }
    .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: var(--radius-full); transition: transform 0.2s; }
    .toggle.active::after { transform: translateX(20px); }
    
    .image-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 350; display: none; align-items: center; justify-content: center; padding: 20px; }
    .image-viewer.show { display: flex; }
    .image-viewer img { max-width: 100%; max-height: 90vh; border-radius: 8px; }
    .image-viewer-close { position: absolute; top: 20px; right: 20px; width: 44px; height: 44px; border-radius: var(--radius-full); background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    .loading { display: flex; align-items: center; justify-content: center; padding: 20px; color: var(--text-sec); gap: 12px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: var(--radius-full); animation: spin 1s linear infinite; }
    
    @media (min-width: 768px) {
      #app { flex-direction: row; }
      .sidebar { width: 320px; border-right: 1px solid var(--border); }
      .menu-btn, .bottom-nav { display: none; }
      .chat-view { flex: 1; border-left: 1px solid var(--border); }
    }
    @media (max-width: 480px) {
      .message { max-width: 85%; }
      .login-card { padding: 24px 20px; }
    }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-logo-icon"><i class="fas fa-comments"></i></div>
        <h1>ChatDCuba</h1>
        <p>Conecta con la comunidad</p>
      </div>
      <input type="text" id="username" class="input" placeholder="Tu nombre" maxlength="20" autocomplete="off">
      <button class="btn" onclick="app.login()"><i class="fas fa-sign-in-alt"></i>Entrar</button>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="connection" id="connection"><i class="fas fa-wifi"></i> Sin conexión</div>
    
    <header class="header">
      <button class="icon-btn menu-btn" onclick="app.toggleSidebar()"><i class="fas fa-bars"></i></button>
      <h1 class="header-title">ChatDCuba</h1>
      <button class="icon-btn" onclick="app.openSettings()"><i class="fas fa-cog"></i></button>
    </header>
    
    <main class="main-content" id="main-view">
      <section class="stories-bar">
        <div class="stories-bar-title">Historias</div>
        <div class="stories-list" id="stories-list">
          <div class="story-item" onclick="app.openCreateStory()">
            <div class="story-ring"><div class="story-avatar story-add" id="my-avatar"><i class="fas fa-plus"></i></div></div>
            <div class="story-name">Tu historia</div>
          </div>
        </div>
      </section>
      
      <section class="chats-section">
        <div class="chats-header"><span class="chats-title">Chats recientes</span></div>
        <div class="chats-search"><input type="search" id="search" placeholder="Buscar..." oninput="app.filter()"></div>
        <div class="chat-list" id="chat-list"></div>
      </section>
    </main>
    
    <div class="chat-view" id="chat-view">
      <div class="chat-view-header">
        <button class="chat-view-back" onclick="app.backToMain()"><i class="fas fa-arrow-left"></i></button>
        <div class="chat-view-avatar" id="chat-avatar"><i class="fas fa-users"></i></div>
        <div class="chat-view-details">
          <h2 id="chat-title">Chat</h2>
          <span id="chat-status"><i class="fas fa-info-circle"></i> Bienvenido</span>
        </div>
      </div>
      
      <div class="messages-container" id="messages">
        <div class="empty-state" id="empty-msg">
          <div class="empty-icon"><i class="fas fa-comments"></i></div>
          <h3>Comienza a chatear</h3>
          <p>Escribe un mensaje para iniciar</p>
        </div>
      </div>
      
      <div class="typing-indicator" id="typing"><span>Escribiendo</span><div class="typing-dots"><span></span><span></span><span></span></div></div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <input type="text" id="msg-input" placeholder="Escribe un mensaje..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="app.send()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="fas fa-info-circle"></i><span id="toast-msg"></span></div>

  <div class="modal" id="story-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="story-modal-title">Historia</h3><button class="modal-close" onclick="app.closeStoryModal()"><i class="fas fa-times"></i></button></div>
      <div class="modal-body" id="story-modal-body"></div>
    </div>
  </div>

  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header"><h3>Ajustes</h3><button class="modal-close" onclick="app.closeSettings()"><i class="fas fa-times"></i></button></div>
      <div class="modal-body">
        <div class="settings-section">
          <h4>Apariencia</h4>
          <div class="setting-item">
            <div class="setting-info"><h5>Modo oscuro</h5><p>Tema claro/oscuro</p></div>
            <div class="toggle" id="theme-toggle" onclick="app.toggleTheme()"></div>
          </div>
        </div>
        <div class="settings-section">
          <h4>Cuenta</h4>
          <div class="setting-item">
            <div class="setting-info"><h5>Usuario</h5><p id="settings-username">-</p></div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="app.closeSettings()">Cerrar</button></div>
    </div>
  </div>

  <div class="image-viewer" id="image-viewer"><button class="image-viewer-close" onclick="app.closeImageViewer()"><i class="fas fa-times"></i></button><img id="image-viewer-img" src="" alt=""></div>

  <script>
    const API = 'https://dlhuhbmpcojhcxosxlax.supabase.co/rest/v1';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsaHVoYm1wY29qaGN4b3N4bGF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzAyMzgsImV4cCI6MjA4NzQ0NjIzOH0.2_RNsO3kUfCoNfpMdPt9v7HIUwo_bycPLL6BG5hAc1I';
    
    const app = {
      user: null, chat: null, isGroup: false, users: {}, stories: {}, typingTimeout: null,
      dark: localStorage.getItem('theme') === 'dark',
      
      init() {
        if (this.dark) document.documentElement.setAttribute('data-dark', '');
        this.loadUser();
        this.setupEvents();
        this.checkConnection();
        setInterval(() => this.checkConnection(), 30000);
        setInterval(() => this.loadStories(), 60000);
      },
      
      loadUser() {
        const saved = localStorage.getItem('chatdcuba_user');
        if (saved) {
          try {
            this.user = JSON.parse(saved);
            this.showApp();
            this.syncUser();
            this.loadChats();
            this.loadStories();
          } catch(e) { localStorage.removeItem('chatdcuba_user'); }
        }
      },
      
      async login() {
        const name = document.getElementById('username').value.trim();
        if (name.length < 2) return this.toast('Nombre muy corto', 'error');
        this.user = { id: this.sanitizeId(name), name, avatar: name[0].toUpperCase(), online: true };
        localStorage.setItem('chatdcuba_user', JSON.stringify(this.user));
        await this.syncUser();
        this.showApp();
        this.toast('¡Bienvenido!', 'success');
        this.loadChats();
        this.loadStories();
      },
      
      async syncUser() {
        if (!this.user) return;
        try {
          await fetch(API + '/users', { method: 'POST', headers: { 'apikey': KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify({ id: this.user.id, username: this.user.name, avatar: this.user.avatar, online: true, last_seen: new Date().toISOString() }) });
        } catch(e) {}
      },
      
      async logout() {
        if (this.user) {
          try { await fetch(API + '/users?id=eq.' + this.user.id, { method: 'PATCH', headers: { 'apikey': KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify({ online: false, last_seen: new Date().toISOString() }) }); } catch(e) {}
        }
        localStorage.removeItem('chatdcuba_user');
        location.reload();
      },
      
      showApp() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('my-avatar').innerHTML = '<i class="fas fa-plus"></i>';
        document.getElementById('settings-username').textContent = this.user.name;
      },
      
      setupEvents() {
        const self = this, input = document.getElementById('msg-input');
        input.addEventListener('keypress', e => { if (e.key === 'Enter') self.send(); });
        input.addEventListener('input', () => self.typingInd());
        window.addEventListener('online', () => { document.getElementById('connection').classList.remove('show', 'offline'); self.loadChats(); });
        window.addEventListener('offline', () => { const c = document.getElementById('connection'); c.classList.add('show', 'offline'); });
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); }));
      },
      
      checkConnection() {
        const online = navigator.onLine, el = document.getElementById('connection');
        if (!online) { el.classList.add('show', 'offline'); }
        else if (el.classList.contains('show')) el.classList.remove('show', 'offline');
      },
      
      toggleTheme() {
        this.dark = !this.dark;
        document.documentElement.setAttribute('data-theme', this.dark ? 'dark' : '');
        localStorage.setItem('theme', this.dark ? 'dark' : 'light');
        document.getElementById('theme-toggle').classList.toggle('active', this.dark);
      },
      
      toast(msg, type = 'info') {
        const t = document.getElementById('toast'), icons = { info: 'fa-info-circle', success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle' };
        t.innerHTML = '<i class="fas ' + icons[type] + '"></i><span id="toast-msg"></span>';
        document.getElementById('toast-msg').textContent = msg;
        t.className = 'toast ' + type + ' show';
        setTimeout(() => t.classList.remove('show'), 2500);
      },
      
      sanitizeId(str) { return str.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, ''); },
      escapeHtml(str) { if (!str) return ''; const d = document.createElement('div'); d.textContent = str; return d.innerHTML; },
      
      async loadChats() {
        try {
          const res = await fetch(API + '/users?order=last_seen.desc', { headers: { 'apikey': KEY } });
          if (!res.ok) throw new Error();
          const users = await res.json();
          this.users = users.reduce((acc, u) => { acc[u.id] = u; return acc; }, {});
          this.renderChats();
        } catch(e) { this.toast('Error al cargar', 'error'); }
      },
      
      renderChats() {
        const list = document.getElementById('chat-list');
        list.innerHTML = '';
        const g = document.createElement('div');
        g.className = 'chat-item';
        g.onclick = () => this.openChat('general', 'Sala General', true);
        g.innerHTML = '<div class="chat-avatar"><i class="fas fa-users"></i></div><div class="chat-info"><div class="chat-name">Sala General</div><div class="chat-preview">Chat público</div></div>';
        list.appendChild(g);
        Object.values(this.users).forEach(u => {
          if (u.id === this.user?.id) return;
          const id = [this.user.id, u.id].sort().join('_'), item = document.createElement('div');
          item.className = 'chat-item';
          item.onclick = () => this.openChat(id, u.username, false);
          const av = u.avatar?.startsWith('http') ? '<img src="' + u.avatar + '">' : this.escapeHtml(u.avatar || u.username[0].toUpperCase());
          item.innerHTML = '<div class="chat-avatar ' + (u.online ? 'online' : 'offline') + '">' + av + '</div><div class="chat-info"><div class="chat-name">' + this.escapeHtml(u.username) + '</div><div class="chat-preview">' + (u.online ? 'En línea' : 'Offline') + '</div></div>';
          list.appendChild(item);
        });
      },
      
      filter() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('.chat-item').forEach(el => {
          const name = el.querySelector('.chat-name')?.textContent.toLowerCase() || '';
          el.style.display = name.includes(q) ? 'flex' : 'none';
        });
      },
      
      openChat(chatId, name, isGroup) {
        this.chat = chatId; this.isGroup = isGroup;
        document.getElementById('main-view').style.display = 'none';
        document.getElementById('chat-view').classList.add('active');
        const av = document.getElementById('chat-avatar');
        if (isGroup) av.innerHTML = '<i class="fas fa-users"></i>';
        else {
          const u = Object.values(this.users).find(x => x.username === name);
          if (u?.avatar?.startsWith('http')) av.innerHTML = '<img src="' + u.avatar + '">';
          else av.textContent = (u?.avatar || name[0].toUpperCase());
        }
        document.getElementById('chat-title').textContent = name;
        document.getElementById('chat-status').innerHTML = isGroup ? '<i class="fas fa-users"></i> Sala pública' :
          (Object.values(this.users).find(x => x.username === name)?.online ? '<i class="fas fa-circle"></i> En línea' : '<i class="fas fa-circle"></i> Offline');
        document.getElementById('chat-status').className = isGroup ? '' : (Object.values(this.users).find(x => x.username === name)?.online ? '' : 'offline');
        document.getElementById('messages').innerHTML = '<div class="empty-state" id="empty-msg"><div class="empty-icon"><i class="fas fa-comments"></i></div><h3>Comienza a chatear</h3><p>Escribe un mensaje</p></div>';
        this.loadMessages();
      },
      
      backToMain() {
        document.getElementById('chat-view').classList.remove('active');
        document.getElementById('main-view').style.display = 'flex';
        this.chat = null;
      },
      
      async loadMessages() {
        if (!this.chat) return;
        const c = document.getElementById('messages');
        c.innerHTML = '<div class="loading"><div class="spinner"></div>Cargando...</div>';
        try {
          const res = await fetch(API + '/messages?chat_id=eq.' + this.chat + '&order=created_at.asc&limit=50', { headers: { 'apikey': KEY } });
          if (!res.ok) throw new Error();
          const msgs = await res.json();
          c.innerHTML = '';
          let lastDate = '';
          msgs.forEach(m => {
            const date = new Date(m.created_at).toLocaleDateString();
            if (date !== lastDate) { c.innerHTML += '<div class="system-message">' + this.escapeHtml(date) + '</div>'; lastDate = date; }
            c.innerHTML += this.renderMsg(m);
          });
          c.scrollTop = c.scrollHeight;
        } catch(e) {
          c.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fas fa-exclamation-triangle"></i></div><h3>Error</h3><p>No se pudieron cargar</p></div>';
          this.toast('Error', 'error');
        }
      },
      
      renderMsg(m) {
        if (m.type === 'system') return '<div class="system-message"><i class="fas fa-info-circle"></i> ' + this.escapeHtml(m.text) + '</div>';
        const own = m.user_id === this.user?.id, time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        let content = '';
        if (m.image) content += '<img src="' + m.image + '" class="message-image" onclick="app.viewImg(\'' + m.image + '\')">';
        if (m.text) content += '<div class="message-text">' + this.escapeHtml(m.text) + '</div>';
        return '<div class="message ' + (own ? 'own' : 'other') + ' animate-slide"><div class="message-bubble">' + content + '<div class="message-meta">' + time + '</div></div></div>';
      },
      
      async send() {
        const input = document.getElementById('msg-input'), text = input.value.trim();
        if (!text || !this.chat) return;
        const msg = { chat_id: this.chat, user_id: this.user.id, username: this.user.name, text, created_at: new Date().toISOString() };
        try {
          const res = await fetch(API + '/messages', { method: 'POST', headers: { 'apikey': KEY, 'Content-Type': 'application/json' }, body: JSON.stringify(msg) });
          if (res.ok) { input.value = ''; document.getElementById('typing').classList.remove('show'); this.loadMessages(); }
          else throw new Error();
        } catch(e) { this.toast('No se pudo enviar', 'error'); }
      },
      
      typingInd() {
        if (!this.chat || !this.user) return;
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => { document.getElementById('typing').classList.remove('show'); }, 2000);
      },
      
      viewImg(url) { document.getElementById('image-viewer-img').src = url; document.getElementById('image-viewer').classList.add('show'); },
      closeImageViewer() { document.getElementById('image-viewer').classList.remove('show'); document.getElementById('image-viewer-img').src = ''; },
      
      async loadStories() {
        try {
          const res = await fetch(API + '/stories?order=created_at.desc', { headers: { 'apikey': KEY } });
          if (!res.ok) throw new Error();
          const stories = await res.json();
          this.stories = stories.reduce((acc, s) => { acc[s.id] = s; return acc; }, {});
          this.renderStories();
        } catch(e) {}
      },
      
      renderStories() {
        const list = document.getElementById('stories-list'), my = list.querySelector('.story-item');
        list.innerHTML = ''; if (my) list.appendChild(my);
        const now = Date.now(), day = 24*60*60*1000;
        Object.values(this.stories).forEach(s => {
          if (now - new Date(s.created_at) > day || s.user_id === this.user?.id) return;
          const item = document.createElement('div');
          item.className = 'story-item'; item.onclick = () => this.viewStory(s.id);
          const av = s.image ? '<img src="' + s.image + '">' : '<span>' + this.escapeHtml(s.avatar || s.username[0].toUpperCase()) + '</span>';
          item.innerHTML = '<div class="story-ring"><div class="story-avatar">' + av + '</div></div><div class="story-name">' + s.username.split(' ')[0] + '</div>';
          list.appendChild(item);
        });
      },
      
      openCreateStory() {
        const body = document.getElementById('story-modal-body');
        document.getElementById('story-modal-title').textContent = 'Crear Historia';
        body.innerHTML = '<form class="story-form" onsubmit="app.publishStory();return false"><textarea id="story-text" placeholder="¿Qué estás pensando?" maxlength="500"></textarea><div class="char-count" id="char-count">0/500</div><button type="submit" class="btn"><i class="fas fa-paper-plane"></i>Publicar</button></form>';
        const ta = document.getElementById('story-text'), cc = document.getElementById('char-count');
        ta.addEventListener('input', () => { const l = ta.value.length; cc.textContent = l + '/500'; });
        document.getElementById('story-modal').classList.add('show');
      },
      
      async publishStory() {
        const text = document.getElementById('story-text')?.value.trim();
        if (!text || text.length < 5) { this.toast('Mínimo 5 caracteres', 'warning'); return; }
        await fetch(API + '/stories', { method: 'POST', headers: { 'apikey': KEY, 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: this.user.id + '_' + Date.now(), user_id: this.user.id, username: this.user.name, avatar: this.user.avatar, text, created_at: new Date().toISOString() }) });
        this.toast('Historia publicada', 'success'); this.closeStoryModal(); this.loadStories();
      },
      
      viewStory(id) {
        const s = this.stories[id]; if (!s) { this.toast('No encontrada', 'error'); return; }
        const body = document.getElementById('story-modal-body'); document.getElementById('story-modal-title').textContent = 'Historia';
        const date = new Date(s.created_at), sec = Math.floor((Date.now() - date)/1000), ago = sec < 60 ? 'Ahora' : sec < 3600 ? 'Hace ' + Math.floor(sec/60) + ' min' : 'Hace ' + Math.floor(sec/3600) + ' h';
        const av = s.avatar && !s.avatar.startsWith('http') ? '<span>' + s.avatar + '</span>' : (s.avatar ? '<img src="' + s.avatar + '">' : '<span>' + s.username[0].toUpperCase() + '</span>');
        body.innerHTML = '<div class="story-view"><div class="story-view-ring"><div class="story-view-avatar">' + av + '</div></div><div class="story-view-name">' + this.escapeHtml(s.username) + '</div><div class="story-view-time">' + ago + '</div>' + (s.text ? '<div class="story-view-text">' + this.escapeHtml(s.text) + '</div>' : '') + '<button class="btn btn-secondary" onclick="app.closeStoryModal()">Cerrar</button></div>';
        document.getElementById('story-modal').classList.add('show');
      },
      
      closeStoryModal() { document.getElementById('story-modal').classList.remove('show'); },
      
      openSettings() {
        document.getElementById('theme-toggle').classList.toggle('active', this.dark);
        document.getElementById('settings-modal').classList.add('show');
      },
      closeSettings() { document.getElementById('settings-modal').classList.remove('show'); }
    };
    
    app.init();
  </script>
</body>
</html>